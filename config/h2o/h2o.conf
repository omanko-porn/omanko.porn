user: h2o
max-connections: 10240
access-log: /dev/stdout
error-log: /dev/stderr

limit-request-body: 3221225472 # 1024 * 1024 * 1024 * 3 (3GB)

http2-casper: ON

compress:
  - gzip
  - br

file.etag: OFF
file.mime.addtypes:
  "application/javascript":
    extensions:
      - .js
    is_compressible: YES
    priority: highest
  "text/css":
    extensions:
      - .css
    is_compressible: YES
    priority: highest
file.send-compressed: ON

hosts:
  "omanko.porn:443":
    listen:
      port: 443
      ssl: !file /etc/h2o/default_ssl.conf
    error-doc:
      - status: 500
        url: /500.html
      - status: 502
        url: /500.html
      - status: 503
        url: /500.html
      - status: 504
        url: /500.html
    header.set: "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload"
    header.set: "Content-Security-Policy: child-src https:; connect-src 'self' https://assets.omanko.porn wss://omanko.porn; default-src 'self'; font-src 'self' https://assets.omanko.porn https://fonts.gstatic.com; img-src https: data: blob:; media-src https:; object-src 'none'; report-uri https://omanko.report-uri.io/r/default/csp/enforce; script-src 'self' https://assets.omanko.porn; style-src 'self' 'unsafe-inline' https://assets.omanko.porn https://fonts.googleapis.com"
    header.set: "Referrer-Policy: no-referrer"
    proxy.preserve-host: ON
    proxy.header.set: "X-Forwarded-Proto: https"
    proxy.timeout.io: 3000
    paths:
      /:
        header.add: "Link: <https://assets.omanko.porn>; rel=preconnect"
        header.add: "Link: <https://files.omanko.porn>; rel=preconnect"
        file.dir: /var/www/html
        mruby.handler: |
          class Manifest
            ASSETS = {
              'common.css' => 'style',
              'common.js' => 'script',
            }.freeze

            def initialize(path)
              @manifest = JSON.parse(File.read(path))
            end

            def call(env)
              [399, override_headers(env), []]
            end

            private

            def override_headers(env = {})
              return {} if env['REQUEST_METHOD']&.downcase != 'get'

              accepts = env['HTTP_ACCEPT']&.split(/,\s*/) || []
              return {} unless accepts.include?('text/html')

              path = env['PATH_INFO'] || '/'
              return {} unless path =~ %r{\A/(?:(?:about|terms|users|web|@[^/]+)/?|\z)}

              push_paths = @manifest.select { |name, _| ASSETS.has_key?(name) }
              { 'link' => push_paths.map { |name, path| "<#{path}>; rel=preload; as=#{ASSETS[name]}" }.join("\n") }
            end
          end

          Manifest.new('/var/www/html/packs/manifest.json')
        proxy.reverse.url: "http://web:3000/"
      /settings:
        proxy.reverse.url: "http://web:3000/settings"
        proxy.timeout.io: 10000
      /admin:
        proxy.reverse.url: "http://web:3000/admin"
        proxy.timeout.io: 10000
      /pghero:
        header.unset: Content-Security-Policy
        proxy.reverse.url: "http://web:3000/pghero"
        proxy.timeout.io: 10000
      /sidekiq:
        header.unset: Content-Security-Policy
        proxy.reverse.url: "http://web:3000/sidekiq"
        proxy.timeout.io: 10000
      /api:
        proxy.reverse.url: "http://web:3000/api"
        proxy.timeout.io: 30000
      /api/v1/streaming:
        proxy.reverse.url: "http://streaming:4000/api/v1/streaming"
        proxy.websocket: ON
        proxy.websocket.timeout: 30000
      /sw.js:
        expires: 0 day
        file.file: /var/www/html/assets/sw.js
      /emoji:
        header.set: "Cache-Control: max-age=31536000, public, immutable"
        proxy.reverse.url: "http://web:3000/emoji"
        proxy.timeout.io: 30000
      /assets:
        header.add: "Cache-Control: max-age=31536000, public, immutable"
        file.dir: /var/www/html/assets
      /packs:
        header.add: "Cache-Control: max-age=31536000, public, immutable"
        file.dir: /var/www/html/packs

  "assets.omanko.porn:443":
    listen:
      port: 443
      ssl: !file /etc/h2o/default_ssl.conf
    header.add: "Cache-Control: max-age=31536000, public, immutable"
    header.add: "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload"
    header.add: "Access-Control-Allow-Origin: https://omanko.porn"
    paths:
      /:
        file.dir: /var/www/html
      /emoji:
        proxy.reverse.url: "http://web:3000/emoji"
        proxy.preserve-host: ON
        proxy.header.set: "X-Forwarded-Proto: https"
        proxy.timeout.io: 30000

  "files.omanko.porn:443":
    listen:
      port: 443
      ssl: !file /etc/h2o/default_ssl.conf
    header.set: "Cache-Control: max-age=31536000, public, immutable"
    header.set: "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload"
    header.set: "Access-Control-Allow-Origin: https://omanko.porn"
    paths:
      /:
        proxy.reverse.url: "http://cache:80/"
        proxy.preserve-host: ON
        proxy.timeout.io: 60000

  "www.omanko.porn:443":
    listen:
      port: 443
      ssl: !file /etc/h2o/default_ssl.conf
    header.set: "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload"
    paths:
      /:
        redirect:
          status: 301
          url: https://omanko.porn/

  default:
    listen:
      port: 80
    paths:
      /:
        - mruby.handler: |
            lambda do |env|
              host = env['HTTP_HOST']
              host = 'omanko.porn' if host == 'www.omanko.porn'
              path = [env['PATH_INFO'], env['QUERY_STRING']].reject(&:empty?).join('?')
              uri = "https://#{host}#{path}"

              headers = {
                'Content-Type' => 'text/html',
                'Location' => uri,
              }
              body = [
                '<!DOCTYPE html>',
                '<title>Moved</title>',
                %(<p>The document has moved <a href="#{uri}">here</a>),
                '',
              ].join("\n")

              [301, headers, [body]]
            end
      /.well-known/acme-challenge:
        file.dir: /var/www/html/.well-known/acme-challenge
